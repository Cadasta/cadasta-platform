upstream django {
    server unix:{{ uwsgi_socket }};
}

map $sent_http_content_type $expires {
    default                     off;
    text/html                   epoch;
    text/css                    24h;
    application/javascript      24h;
    ~image/                     24h;
}

server {
    listen      80;

    set $should_redirect 0;
    # Redirect any HTTP requests to HTTPS
    if ($http_x_forwarded_proto != 'https') {
        set $should_redirect 1;
    }
    # ... except for ELB Healthchecks, those come in at HTTP being that
    # they occur behind the load balancer, where everything is HTTP
    if ($http_user_agent ~* '^ELB-HealthChecker\/.*$') {
        set $should_redirect 0;
    }
    if ($should_redirect) {
        return 301 https://$host$request_uri;
    }

    expires $expires;
    etag on;
    add_header Cache-Control "private, must-revalidate";

    charset     utf-8;

    gzip                on;
    gzip_http_version   1.0;
    gzip_disable        "msie6";
    gzip_min_length     500;
    gzip_buffers        16 8k;
    gzip_proxied        expired no-cache no-store private;
    gzip_types          *;
    gzip_vary           on;

    client_max_body_size 75M;

    # alias favicon.* to static
    location ~ ^/favicon.(\w*)$ {
        alias   {{ application_path }}cadasta/static/favicon.png;
    }

    location /static/ {
        alias   {{ application_path }}cadasta/static/;
    }

    location / {
        uwsgi_pass  django;
        include {{ application_path }}uwsgi_params;
        add_header 'X-Robots-Tag' 'noindex, nofollow, nosnippet, noarchive, noodp, noimageindex';
    }
}
