{% extends "core/base.html" %}

{% load staticfiles %}
{% load i18n %}

{% block top-nav %}dashboard{% endblock %}
{% block body-class %} map{% endblock %}

{% block title %} | {% trans "Dashboard" %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.css">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}">
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.js"></script>
<script src="{% static 'js/leaflet.markercluster.js' %}"></script>
<script src="{% static 'js/L.Map.Deflate.js' %}"></script>
<script>
  function project_map_init(map, options) {
    map.fitBounds([[-45.0, -180.0], [45.0, 180.0]]);
    var features = L.deflate({minSize: 20, markerCluster: true});
    features.addTo(map);

    var data = {{ geojson|safe }};
    var geoJson = L.geoJson(data, {
      onEachFeature: function(feature, layer) {
        layer.bindPopup("<div class=\"text-wrap\">" +
                       "<h2><span>" + feature.properties.org + "</span>" +
                       feature.properties.name + "</h2></div>" +
                       "<div class=\"btn-wrap\"><a href='" + feature.properties.url + "' class=\"btn btn-primary btn-sm btn-block\">{% trans 'Open project' %}</a>"  +
                       "</div>");
      }
    });
    geoJson.addTo(features);
  }

  function add_tile_layers() {
    for (var i = 0, n = layers.length; i < n; i++) {
      var options = L.Util.extend(layers[i]['attrs']);
      var layer = {name: layers[i]['label'], url: layers[i]['url'], options: options};

      var l = L.tileLayer(layer.url, layer.options);
      layerscontrol.addBaseLayer(l, layer.name);

      if (i === 0) {
        l.addTo(map); 
      }
    }
  }

  var map = L.map('mapid');
  var layers = {{ leaflet_tiles|safe }};
  var layerscontrol = L.control.layers().addTo(map);
  add_tile_layers();
  project_map_init(map);

</script>
{% endblock %}

{% block content %}

<div id="dashboard-map">
  <div id='mapid'></div>
</div>

{% endblock %}
