{% extends "core/base.html" %}

{% load staticfiles %}
{% load i18n %}

{% block top-nav %}dashboard{% endblock %}
{% block body-class %} map{% endblock %}

{% block title %} | {% trans "Dashboard" %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.css">
<!-- <link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}"> -->
<!-- <link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}"> -->
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.js"></script>
<!-- <script src="{% static 'js/leaflet.markercluster.js' %}"></script> -->
<!-- <script src="{% static 'js/L.Map.Deflate.js' %}"></script> -->
<!-- <script src="{% static 'js/smap/index.js' %}"></script> -->
<script>
  function project_map_init(map, options) {
    var data = {{ geojson|safe }};
    map.fitBounds([[-45.0, -180.0], [45.0, 180.0]]);

    // add_map_controls(map);

    var geoJson = L.geoJson(null, {
      onEachFeature: function(feature, layer) {
        layer.bindPopup("<div class=\"text-wrap\">" +
                       "<h2><span>" + feature.properties.org + "</span>" +
                       feature.properties.name + "</h2></div>" +
                       "<div class=\"btn-wrap\"><a href='" + feature.properties.url + "' class=\"btn btn-primary btn-sm btn-block\">{% trans 'Open project' %}</a>"  +
                       "</div>");
      }
    });

    geoJson.addData(data);
    geoJson.addTo(map);
  }

  function add_tile_layers() {
    for (var i = 0, n = layers.length; i < n; i++) {
      var options = L.Util.extend(layers[i]['attrs']);
      var layer = {name: layers[i]['label'], url: layers[i]['url'], options: options};

      var l = L.tileLayer(layer.url, layer.options);
      layerscontrol.addBaseLayer(l, layer.name);

      if (i === 0) {
        l.addTo(map); 
      }
    }
  }

  var map = L.map('mapid');
  var layers = {{ leaflet_tiles|safe }}
  var layerscontrol = L.control.layers().addTo(map);
  add_tile_layers()
  project_map_init(map)

  // {% if project.extent %}
  //   var projectExtent = {{ project.extent.geojson|safe }};
  // {% else %}
  //   var projectExtent = null;
  // {% endif %}

  // var options = {
  //   projectExtent: projectExtent,
  //   trans: trans,
  //   fitBounds: '{{ boundary }}'
  // }

</script>
{% endblock %}

{% block content %}

<div id="dashboard-map">
  <div id='mapid'></div>
</div>

{% endblock %}
