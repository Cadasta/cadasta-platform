{% extends "core/base.html" %}

{% load staticfiles %}
{% load i18n %}

{% block top-nav %}dashboard{% endblock %}
{% block body-class %} map{% endblock %}

{% block title %} | {% trans "Dashboard" %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.8.0/leaflet-geocoder-mapzen.css">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}">
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.8.0/leaflet-geocoder-mapzen.js"></script>
<script src="{% static 'js/leaflet.markercluster.js' %}"></script>
<script src="{% static 'js/L.Map.Deflate.js' %}"></script>
<script>
  function project_map_init(map, options) {
    map.fitBounds([[-45.0, -180.0], [45.0, 180.0]]);
    var features = L.deflate({minSize: 20, markerCluster: true});
    features.addTo(map);

    var data = {{ geojson|safe }};
    var geoJson = L.geoJson(data, {
      onEachFeature: function(feature, layer) {
        layer.bindPopup("<div class=\"text-wrap\">" +
                       "<h2><span>" + feature.properties.org + "</span>" +
                       feature.properties.name + "</h2></div>" +
                       "<div class=\"btn-wrap\"><a href='" + feature.properties.url + "' class=\"btn btn-primary btn-sm btn-block\">{% trans 'Open project' %}</a>"  +
                       "</div>");
      }
    });
    geoJson.addTo(features);

    function geoLocate() {
      return function(event) {
        map.locate({ setView: true });
      };
    };

    function add_map_controls() {
      map.removeControl(map.zoomControl);
      map.addControl(L.control.zoom({
        zoomInTitle: gettext("Zoom in"),
        zoomOutTitle: gettext("Zoom out")
      }));

      var geocoder = L.control.geocoder('search-QctWfva', {
        markers: false
      }).addTo(map);

      geocoder.on('click', function (e) {
        map.setZoomAround(e.latlng, 9);
      });

      var Geolocate = L.Control.extend({
        options: {
          position: 'topleft'
        },

        onAdd: function() {
          var controlDiv = L.DomUtil.create(
            'div', 'leaflet-bar leaflet-control leaflet-control-geolocate'
          );
          controlDiv.title = gettext('Go to my location');
          L.DomEvent
           .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
           .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
           .addListener(controlDiv, 'click', geoLocate(map));

          L.DomUtil.create('span', 'glyphicon glyphicon-map-marker', controlDiv);

          return controlDiv;
        }
      });

      map.addControl(new Geolocate());
    }

    add_map_controls();
  }

  function add_tile_layers() {
    for (var i = 0, n = layers.length; i < n; i++) {
      var options = L.Util.extend(layers[i]['attrs']);
      var layer = {name: layers[i]['label'], url: layers[i]['url'], options: options};

      var l = L.tileLayer(layer.url, layer.options);
      layerscontrol.addBaseLayer(l, layer.name);

      if (i === 0) {
        l.addTo(map); 
      }
    }
  }

  var map = L.map('mapid');
  var layers = {{ leaflet_tiles|safe }};
  var layerscontrol = L.control.layers().addTo(map);
  add_tile_layers();
  project_map_init(map);

</script>
{% endblock %}

{% block content %}

<div id="dashboard-map">
  <div id='mapid'></div>
</div>

{% endblock %}
