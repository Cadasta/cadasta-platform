{% extends "organization/project_wrapper.html" %}

{% load i18n %}
{% load leaflet_tags %}
{% load staticfiles %}

{% block extra_head %}
{% leaflet_css plugins="groupedlayercontrol"%}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.css">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}">
{% endblock %}

{% block extra_script %}
{{ block.super }}
{% leaflet_js plugins="groupedlayercontrol"%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.4.0/leaflet-geocoder-mapzen.js"></script>
<script src="{% static 'js/leaflet.markercluster.js' %}"></script>
<script src="{% static 'js/L.Map.Deflate.js' %}"></script>
<script src="{% static 'js/map_utils.js' %}"></script>
<script>

  $(function () {
    $('[data-toggle="tooltip"]').tooltip({container: 'body'});
  });

  function project_map_init(map, options) {
    var trans = {
      open: "{% trans 'Open location' %}"
    };

    add_map_controls(map);

    switch_layer_controls(map, options);

    {% if is_project_member or is_superuser %}
      var projectUser = true;
    {% else %}
      var projectUser = false;
    {% endif %}

    {% if project.extent %}
    var projectExtent = {{ project.extent.geojson|safe }};
    {% else %}
    var projectExtent = null;
    {% endif %}

    renderFeatures(map,
                   '{% url "async:spatial:list" project.organization.slug project.slug %}',
                   {projectExtent: projectExtent, trans: trans, fitBounds: 'project', projectUser: projectUser});

    var orgSlug = '{{ project.organization.slug }}';
    var projectSlug = '{{ project.slug }}';
    var url = '/api/v1/organizations/'
            + orgSlug + '/projects/' + projectSlug + '/spatialresources/';
    add_spatial_resources(map, url);
  }
</script>
{% endblock %}

{% block page_title %}{% if is_project_member %}{% trans "Dashboard" %}{% else %}{% trans "Overview" %} | {% endif %}{% endblock %}
{% block body-class %} dashboard{% endblock %}
{% block left-nav %}dashboard{% endblock %}

{% block content %}

<div class="col-md-12 content-single">
  <div class="row">
    {% if is_project_member %}
      <!-- Project Dashboard for project members  -->
      <div class="main-text">
        <div class="col-md-8">

          <h2>Project Dashboard</h2>

          <!-- Project introduction -->
          {% if is_administrator and not has_content and not project.extent and not questionnaire %}
            <section>
              <div class="panel panel-default">
                <div class="panel-body">
                  {% blocktrans %}
                  <p>Welcome to your newly created project! Here’s what you need to do to get it set up:</p>
                  {% endblocktrans %}
                  <div class="media">
                    <div class="media-left">
                      <i class="fa fa-check-circle fa-2x text-success" aria-hidden="true"></i>
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"><a href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">{% trans "Name your project" %}</a></h4>
                      <p>{% trans "Give your project a name and description. You can also set contacts, visibility, and other project details." %}</p>
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <i class="fa fa-2x {% if not project.extent and num_locations == 0 %}fa-times-circle text-danger{% else %}fa-check-circle text-success{% endif %}" aria-hidden="true"></i>
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"><a href="{% url 'organization:project-edit-geometry' object.organization.slug object.slug %}">{% trans "Define your project map" %}</a></h4>
                      <p>{% trans "Draw your boundary on the map and mark where you are going to be collecting data." %}</p>
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <i class="fa fa-2x {% if not questionnaire and not has_content %}fa-times-circle text-danger{% else %}fa-check-circle text-success{% endif %}" aria-hidden="true"></i>
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"><a href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">{% trans "Upload your questionnaire" %}</a></h4>
                      <p>{% trans "Upload the Cadasta XLSForm that best fits your project." %}</p>
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <i class="fa fa-2x {% if not members %}fa-times-circle text-danger{% else %}fa-check-circle text-success{% endif %}" aria-hidden="true"></i>
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"><a href="{% url 'organization:members' object.organization.slug %}">{% trans "Select your team members" %}</a></h4>
                      <p>{% trans "Add new team members or assign member permissions to your project ." %}</p>
                    </div>
                  </div>
                  <hr class="border-btm">
                  {% blocktrans %}
                  <p>For additional assistance, refer to the <a href="https://docs.cadasta.org/" target="_blank">platform documentation</a> – the answer you need may be in there.</p>
                  {% endblocktrans %}              
                </div>
              </div>
            </section>
          {% endif %}

          <!-- Project stats -->
          {% if has_content %}
            <section>
              <div class="row">
                <div class="col-sm-4">
                  <a href="{% url 'locations:list' object.organization.slug object.slug %}" title="{% trans 'Project locations' %}" class="tile-box btn btn-primary">
                    <div class="tile-header">{% trans "Locations" %}</div>
                    <div class="tile-content-wrapper">
                      <i class="fa fa-map-marker"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_locations }}</span>
                      </div>
                    </div>
                  </a>
                </div>
                <div class="col-sm-4">
                  <a href="{% url 'parties:list' object.organization.slug object.slug %}" title="{% trans 'Project parties' %}" class="tile-box btn btn-primary">
                    <div class="tile-header">{% trans "Parties" %}</div>
                    <div class="tile-content-wrapper">
                      <i class="fa fa-user"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_parties }}</span>
                      </div>
                    </div>
                  </a>
                </div>
                <div class="col-sm-4">
                  <a href="{% url 'resources:project_list' object.organization.slug object.slug %}" title="{% trans 'Project resources' %}" class="tile-box btn btn-primary">
                    <div class="tile-header">{% trans "Resources" %}</div>
                    <div class="tile-content-wrapper">
                      <i class="fa fa-file"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_resources }}</span>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </section>
          {% endif %}

          <!-- Project map -->
          <section>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title inline">{% trans "Project Map" %}</h3>
                {% if is_administrator %}
                  <a href="{% url 'organization:project-edit-geometry' object.organization.slug object.slug %}">
                    <i class="glyphicon glyphicon-cog" data-toggle="tooltip" data-trigger="hover" data-placement="right" title="{% trans 'Edit project map' %}">
                    </i>
                  </a>
                  <a href="{% url 'locations:add' object.organization.slug object.slug %}">
                    <i class="glyphicon glyphicon-plus" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{% trans 'Add location' %}"></i>
                  </a>
                {% endif %}
              </div>
              <div class="panel-body">
                {% if not project.extent and is_administrator and num_locations == 0%}
                  <div class="overlay-wrapper map">
                    <div class="overlay">
                      {% blocktrans %}
                      <p>You haven't defined a project extent yet.
                      Would you like to add a project extent?</p>
                      {% endblocktrans %}
                      <div class="text-center">
                        <a href="{% url 'organization:project-edit-geometry' object.organization.slug object.slug %}" class="btn btn-primary">{% trans "Define a project extent" %}</a>
                        <a href="#" class="btn btn-primary hidden">{% trans "Use global map" %}</a>
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% leaflet_map "project-map" callback="project_map_init" %}
              </div>
            </div>
          </section>

          <!-- Project schema -->
          {% if is_administrator %}
            <section>
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h3 class="panel-title inline">{% trans "Data Collection" %}</h3>
                </div>
                <div class="panel-body">
                  {% if not questionnaire and not has_content %}
                    <div class="overlay-wrapper">
                      <div class="overlay">
                        {% blocktrans %}
                        <p>You haven't designed your data collection by uploading an XLS Form.
                          Do you want to do that now?</p>
                        {% endblocktrans %}
                        <div class="text-center">
                          <a class="btn btn-primary" href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">{% trans "Upload XLS Form" %}</a>
                        </div>
                      </div>
                      <div class="alert alert-info alert-full clearfix row" role="alert">
                        <div class="pull-left"><i class="glyphicon glyphicon-info-sign"></i></div>
                        <div>
                          {% blocktrans %}To get started, choose the form that most closely matches your documentation needs.
                          <ul>
                            <li>The <a href="https://docs.google.com/spreadsheets/d/1MHg6iok4SkDxN2NdMVt3P2W9UZe81VxH6CpAz_eUtOY/pub?output=xlsx" class="alert-link">Customary Rights Form</a> is designed for documenting the rights of a single group of people who are using a single parcel or piece of land.</li>
                            <li>The <a href="https://docs.google.com/spreadsheets/d/1hyF_uxZb4959lxD6vDMM574cQEFTyq636VAS7n3e0MA/pub?output=xlsx" class="alert-link">Sustainable Sourcing Form</a> is for documenting land that's being used for sustainable agricultural production.</li>
                            <li>The <a href="https://docs.google.com/spreadsheets/d/1iORFg75ofq-QzLB5x-WvuggEZN6JaE0iS6yqc7dE1Y0/pub?output=xlsx" class="alert-link">Urban Informal Settlements Form</a> is for documenting many people who may be living in a very small urban area.</li>
                          </ul>
                          If you need help or have questions, <a href="http://cadasta.org/contact/" target="_blank" class="alert-link">please contact us</a>.
                          {% endblocktrans %}
                        </div>
                      </div>
                    </div>
                  {% elif questionnaire and not has_content %}
                    <div class="overlay-wrapper">
                      <div class="overlay">
                        {% blocktrans %}
                        <p>You have designed a data collection for this project but have not collected any data. You can still change your schema.</p>
                        {% endblocktrans %}
                        <div class="text-center">
                          <a class="btn btn-primary" href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">{% trans "Upload new XLS Form" %}</a>
                          <a class="btn btn-primary" href="{{ questionnaire.xls_form.url }}">{% trans "Download current XLS Form" %}</a>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="overlay-wrapper">
                      <div class="text-center">
                        {% if questionnaire %}
                          <a class="btn btn-primary" href="{{ questionnaire.xls_form.url }}">{% trans "Download current XLS Form" %}</a>
                        {% endif %}
                      </div>
                      <div class="alert alert-info alert-full">
                        <i class="glyphicon glyphicon-info-sign"></i>
                        {% blocktrans %}
                        Data has already been contributed to this project. To ensure data integrity, uploading a new questionnaire is disabled for this project.
                        {% endblocktrans %}
                      </div>
                  {% endif %}
                </div>
              </div>
            </section>
          {% endif %}

        </div>

        <div class="col-md-4">

          <!-- Project about -->
          <section>
            <div class="panel panel-default panel-about">
              <div class="panel-heading">
                <h3 class="panel-title inline">{% trans "About this project" %}</h3>
                {% if is_administrator %}
                  <a href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">
                    <i class="glyphicon glyphicon-cog" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{% trans 'Edit project details' %}"></i>
                  </a>
                {% endif %}
              </div>
              <div class="panel-body">
                <p>{{ object.description }}</p>
                {% if object.urls.0 %}
                  <p><a href="{{ object.urls.0 }}" target="_blank" class="break"><i class="glyphicon glyphicon-globe"></i> {{ object.urls.0 }}</a></p>
                {% endif %}
                {% if object.contacts %}
                  <h4 class="panel-subtitle">{% trans "Contacts" %}</h4>
                  <dl class="contacts">
                  {% for contact in object.contacts %}
                    <dt>{{ contact.name }}</dt>
                    <dd class="clearfix">
                      {% if contact.email %}
                      <a href="mailto:{{ contact.email }}" class="break">
                        <i class="glyphicon glyphicon-envelope"></i>
                       {{ contact.email }}
                      </a>
                      {% endif %}
                      {% if contact.tel %}
                      <a href="tel:{{ contact.tel }}">
                        <i class="glyphicon glyphicon-earphone"></i>
                        {{ contact.tel }}
                      </a>
                      {% endif %}
                    </dd>
                  {% endfor %}
                  </dl>
                {% endif %}
              </div>
            </div>
          </section>

          <!-- Project import export -->
          {% if is_administrator %}
            <section>
              <div class="panel panel-default panel-about">
                <div class="panel-heading">
                  <h3 class="panel-title inline">{% trans "Project records" %}</h3>
                </div>
                <div class="panel-body">
                  <a href="{% url 'organization:project-import' object.organization.slug object.slug %}" title="{% trans 'Import project data' %}" class="btn btn-default btn-panel {% if has_content %} btn-half pull-left{% else %} btn-block{% endif %}">
                    <i class="glyphicon glyphicon-import"></i>
                    {% trans "Import data" %}
                  </a>
                  {% if has_content %}
                    <a href="{% url 'organization:project-download' object.organization.slug object.slug %}" title="{% trans 'Export project data' %}" class="btn btn-default btn-panel btn-half pull-right">
                      <i class="glyphicon glyphicon-export"></i>
                      {% trans "Export data" %}
                    </a>
                  {% endif %}
                </div>
              </div>
            </section>
          {% endif %}

          <!-- Project team members -->
          <section>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title inline">{% trans "Team Members" %}</h3>
                {% if is_administrator %}
                  <a href="{% url 'organization:members' object.organization.slug %}">
                    <span class="glyphicon glyphicon-cog" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{% trans 'Manage project members' %}"></span>
                  </a>
                  <a href="{% url 'organization:members_add' object.organization.slug %}">
                    <span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{% trans 'Add new user' %}"></span>
                  </a>
                {% endif %}
              </div>
              <div class="panel-body">
                {% if not members %}
                  <div class="overlay-wrapper">
                    <div class="overlay">
                      {% blocktrans %}
                        <p>You have not added any team members. Would you like to add team members now?</p>
                      {% endblocktrans %}
                      <div class="text-center">
                        <a class="btn btn-primary" href="{% url 'organization:members_add' object.organization.slug %}">{% trans "Add a member" %}</a>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <ul class="list-unstyled list-divider">
                    {% for member, role in members.items %}
                      <li>
                        <i class="fa fa-user-circle fa-2x" aria-hidden="true" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{{member}}"></i> 
                        <strong>{{ member }}</strong>, {{ role }}
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            </div>
          </section>
        </div>

      </div>
    {% else %}
      <!-- Project Overview for non-project members  -->
      <div class="main-text">
        <div class="col-md-8">

        <h2>{% trans "Project Overview" %}</h2>
          {% if not user.is_authenticated %}
            <section>
              <div class="panel panel-default">
                <div class="panel-body">
                  <div class="row">
                    <!-- Sign in link -->
                    <div class="col-sm-6 dashboard-box border-right-dotted">
                      <h3 class="panel-title panel-title-bordered">{% trans "New Users" %}</h3>
                      <p>{% trans "Use the Cadasta platform to collect, manage and store data on land and resource rights in our secure cloud Platform. You can also request to join one of the many ongoing projects. Registration is free and easy." %}</p> 
                      <a href="{% url 'account_signup' %}?next={{ request.path }}" class="btn btn-primary btn-block btn-lg"><i class="fa fa-pencil"></i> {% trans "Register now" %}</a>
                    </div>
                    <!-- Register link -->
                    <div class="col-sm-6 dashboard-box">
                      <h3 class="panel-title panel-title-bordered">{% trans "Have an account?" %}</h3>
                      <p>{% trans "Because we care about protecting your sensitive data, you must sign in to verify you have the proper permission to view project information. Access to project data is restricted to current project members only." %}</p> 
                      <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-primary btn-block btn-lg"><i class="fa fa-lock"></i> {% trans "Sign in" %}</a>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            
          {% elif user.is_authenticated and has_content %}
            <!-- Project stats -->
            <section>
              <div class="row">
                <div class="col-sm-4">
                  <div class="tile-box bg-primary">
                    <div class="tile-header">{% trans "Locations" %}</div>
                    <div class="tile-content-wrapper">
                      <i class="fa fa-map-marker"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_locations }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="tile-box bg-primary">
                    <div class="tile-header">
                      <h3 class="panel-title">{% trans "Parties" %}</h4>
                    </div>
                    <div class="tile-content-wrapper">
                      <i class="fa fa-user"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_parties }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="tile-box bg-primary">
                    <div class="tile-header">{% trans "Resources" %}</div>
                    <div class="tile-content-wrapper">
                      <i class="glyphicon glyphicon-file"></i>
                      <div class="tile-content">
                        <span class="num">{{ num_resources }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          {% endif %}

          <!-- Project map -->
          <section>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">{% trans "Project Map" %}</h3>
              </div>
              <div class="panel-body overview">
                <!-- Display locations without interactions -->
                {% leaflet_map "project-map" callback="project_map_init" %}

              </div>
            </div>
          </section>

        </div>

        <div class="col-md-4">

          <!-- Project about -->
          <section>
            <div class="panel panel-default panel-about">
              <div class="panel-heading">
                <h3 class="panel-title">{% trans "About this project" %}</h3>
                {% if is_administrator %}
                  <a href="{% url 'organization:project-edit-details' object.organization.slug object.slug %}">
                    <i class="glyphicon glyphicon-cog" data-toggle="tooltip" data-trigger="hover" data-placement="left" title="{% trans 'Edit project details' %}"></i>
                  </a>
                {% endif %}
              </div>
              <div class="panel-body">
                <p>{{ object.description }}</p>
                {% if object.urls.0 %}
                  <p><a href="{{ object.urls.0 }}" target="_blank" class="break"><i class="glyphicon glyphicon-globe"></i> {{ object.urls.0 }}</a></p>
                {% endif %}
                {% if object.contacts %}
                  <h4 class="panel-subtitle">{% trans "Contacts" %}</h4>
                  <dl class="contacts">
                  {% for contact in object.contacts %}
                    <dt>{{ contact.name }}</dt>
                    <dd class="clearfix">
                      {% if contact.email %}
                      <a href="mailto:{{ contact.email }}" class="break">
                        <i class="glyphicon glyphicon-envelope"></span>
                       {{ contact.email }}
                      </a>
                      {% endif %}
                      {% if contact.tel %}
                      <a href="tel:{{ contact.tel }}">
                        <i class="glyphicon glyphicon-earphone"></i>
                        {{ contact.tel }}
                      </a>
                      {% endif %}
                    </dd>
                  {% endfor %}
                  </dl>
                {% endif %}
              </div>
            </div>
          </section>

        </div>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
